<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Offline Venues Management</title>
  <!-- Include Firebase SDK (compat versions for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Google Fonts (–Ω–∞–ø—Ä–∏–º–µ—Ä, Poppins) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap">
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    /* Background and layout */
    body {
      background: url("background.png") no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;              /* –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
      flex-direction: column;
      align-items: center;
    }

    h1.site-title {
      color: #fff;
      font-size: 2rem;
      margin-top: 40px;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .card {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 40px;
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 4px 25px rgba(0,0,0,0.15);
    }

    h2 {
      margin-bottom: 15px;
      color: #333;
      font-weight: 600;
      text-align: center; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    }

    .form-section,
    .dashboard {
      margin-bottom: 30px;
    }

    .form-section form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    form label {
      display: block;
      color: #333;
      font-weight: 500;
      margin-bottom: 4px;
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
    select,
    input[type="text"],
    input[type="url"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    select:focus,
    input:focus {
      border-color: #00a9dc;
    }

    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –≤ select */
    select {
      appearance: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ */
      -webkit-appearance: none;
      -moz-appearance: none;
      background: url('icon-arrow.svg') no-repeat 95% center / 16px 16px, #fff;
      padding-right: 2.5rem; /* –û—Ç—Å—Ç—É–ø —Å–ø—Ä–∞–≤–∞ –ø–æ–¥ –∏–∫–æ–Ω–∫—É */
    }
    /* –î–ª—è IE/Edge */
    select::-ms-expand {
      display: none;
    }

    button {
      padding: 12px 24px;
      background-color: #00c2ff;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      font-weight: 500;
      align-self: flex-start; /* –ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç —Å–ª–µ–≤–∞, –º–æ–∂–Ω–æ center */
    }
    button:hover {
      background-color: #00a9dc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .dashboard {
      text-align: center; /* –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ–º —Ä–∞–∑–¥–µ–ª—ã */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 20px;
    }
    th,
    td {
      border: 1px solid #eee;
      padding: 12px;
      text-align: center;
      font-size: 0.95rem;
    }
    th {
      background-color: #f7f7f7;
      color: #333;
      font-weight: 600;
    }
    tbody tr:hover {
      background-color: #f1faff;
    }
    a {
      color: #00c2ff;
      text-decoration: none;
      font-weight: 500;
    }
    a:hover {
      text-decoration: underline;
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-container {
      width: 100px; /* –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å */
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin: 0 auto 4px auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background-color: #00c2ff;
      width: 0%;
      transition: width 0.5s linear;
    }

    .time-text {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>
  <h1 class="site-title">Offline Venues Management</h1>
  <div class="card">
    <!-- Form Section -->
    <div class="form-section">
      <h2>Add Venue</h2>
      <form id="addEstablishmentForm">
        <label>Your Name:</label>
        <input type="text" id="addedBy" required>

        <label>Venue Name:</label>
        <input type="text" id="name" required>

        <label>Venue page URL:</label>
        <input type="url" id="url" required>

        <label>Offline time (in minutes):</label>
        <input type="number" id="offlineTime" required>

        <label>Reason for Offline:</label>
        <select id="reason" required>
          <option value="" disabled selected>Select reason</option>
          <option value="Integration issues / Tech issues">Integration issues / Tech issues</option>
          <option value="Venue sets itself online">Venue sets itself online</option>
        </select>

        <button type="submit">Add venue</button>
      </form>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard">
      <h2>Active Venues</h2>
      <table id="activeTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Time Left</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- If no active venues, we will show "No active venues" -->
        </tbody>
      </table>
      
      <h2>History</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Offline Until</th>
          </tr>
        </thead>
        <tbody>
          <!-- Expired venues will be rendered here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ===================== 1. FIREBASE INITIALIZATION =====================
    const firebaseConfig = {
      apiKey: "AIzaSyBaQYzQmld5VNA_wSI8nDtqENN0TgcNqeA",
      authDomain: "adminsonly.firebaseapp.com",
      databaseURL: "https://adminsonly-default-rtdb.firebaseio.com",
      projectId: "adminsonly",
      storageBucket: "adminsonly.firebasestorage.app",
      messagingSenderId: "194528429901",
      appId: "1:194528429901:web:805ca2f1dd0feca2de1904"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===================== 2. SLACK WEBHOOK =====================
    const slackWebhookURL = "https://hooks.slack.com/triggers/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";
    function sendWebhook(text) {
      const payload = { text: text };
      fetch(slackWebhookURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(() => console.log("Workflow webhook sent."))
      .catch(err => console.error("Webhook error:", err));
    }

    // ===================== 3. ADD VENUE FUNCTION =====================
    function addEstablishment(establishment) {
      const newRef = db.ref("establishments").push();
      establishment.id = newRef.key;
      // Save creation time for progress bar logic:
      establishment.createdAt = new Date().toISOString();
      // Initially, graceExpiresAt is not set (null)
      establishment.graceExpiresAt = null;

      newRef.set(establishment, error => {
        if (!error) {
          const text = `üì¢ The ${establishment.name} venue was set admins only until ${new Date(establishment.offlineUntil).toLocaleString()} by ${establishment.addedBy}\nüîó URL: ${establishment.url}\nReason: ${establishment.reason}`;
          sendWebhook(text);
        } else {
          console.error("Save error:", error);
        }
      });
    }

    let currentEstablishments = [];

    // ===================== 4. SUBSCRIBE TO DATABASE UPDATES =====================
    function subscribeToDashboard() {
      db.ref("establishments").on("value", snapshot => {
        const data = snapshot.val();
        const allEstablishments = data ? Object.values(data) : [];
        currentEstablishments = allEstablishments;
        renderDashboards(allEstablishments);
      });
    }

    // ===================== 5. RENDER DASHBOARDS =====================
    function renderDashboards(establishments) {
      const activeTbody = document.getElementById("activeTable").querySelector("tbody");
      const historyTbody = document.getElementById("historyTable").querySelector("tbody");
      activeTbody.innerHTML = "";
      historyTbody.innerHTML = "";

      let activeCount = 0;
      let historyCount = 0;

      establishments.forEach(est => {
        if (est.expired) {
          historyCount++;
          // Render in History
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);
          
          const tdAddedBy = document.createElement("td");
          tdAddedBy.textContent = est.addedBy || "";
          tr.appendChild(tdAddedBy);
          
          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);
          
          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Link";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          const tdOfflineUntil = document.createElement("td");
          tdOfflineUntil.textContent = new Date(est.offlineUntil).toLocaleString();
          tr.appendChild(tdOfflineUntil);
          
          historyTbody.appendChild(tr);
        } else {
          activeCount++;
          // Render active venue
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);
          
          const tdAddedBy = document.createElement("td");
          tdAddedBy.textContent = est.addedBy || "";
          tr.appendChild(tdAddedBy);
          
          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);
          
          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Link";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          // Cell for progress bar and time text
          const tdTimer = document.createElement("td");
          tdTimer.style.verticalAlign = "middle";

          // Progress container
          const progressContainer = document.createElement("div");
          progressContainer.className = "progress-container";
          progressContainer.id = "progressBar-" + est.id;

          // Progress fill
          const progressFill = document.createElement("div");
          progressFill.className = "progress-fill";
          progressFill.id = "progressFill-" + est.id;
          progressContainer.appendChild(progressFill);

          // Text for time left
          const timeText = document.createElement("div");
          timeText.className = "time-text";
          timeText.id = "timeText-" + est.id;

          tdTimer.appendChild(progressContainer);
          tdTimer.appendChild(timeText);
          tr.appendChild(tdTimer);

          const tdAction = document.createElement("td");
          // Button for adding extra time
          const addTimeBtn = document.createElement("button");
          addTimeBtn.textContent = "Add Extra Time";
          addTimeBtn.addEventListener("click", function() {
            addExtraTime(est.id);
          });
          tdAction.appendChild(addTimeBtn);
          
          // If venue is in grace period, add "Set Expired" button
          if (est.graceExpiresAt) {
            const setExpiredBtn = document.createElement("button");
            setExpiredBtn.textContent = "Set Expired";
            setExpiredBtn.style.marginLeft = "5px";
            setExpiredBtn.addEventListener("click", function() {
              setExpiredNow(est.id);
            });
            tdAction.appendChild(setExpiredBtn);
          }
          tr.appendChild(tdAction);
          
          activeTbody.appendChild(tr);
        }
      });

      // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º "No active venues"
      if (activeCount === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6; // 6 —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ Active
        td.textContent = "No active venues";
        tr.appendChild(td);
        activeTbody.appendChild(tr);
      }
    }

    // ===================== 6. UPDATE TIMERS WITH GRACE PERIOD (10 min) + PROGRESS =====================
    function updateTimers() {
      const now = Date.now();

      currentEstablishments.forEach(est => {
        if (!est.expired) {
          const progressBar = document.getElementById("progressBar-" + est.id);
          const progressFill = document.getElementById("progressFill-" + est.id);
          const timeTextEl = document.getElementById("timeText-" + est.id);

          if (!progressBar || !progressFill || !timeTextEl) return;

          const offlineUntilTime = new Date(est.offlineUntil).getTime();
          const createdTime = new Date(est.createdAt || new Date()).getTime(); // –µ—Å–ª–∏ –Ω–µ—Ç createdAt, –±–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
          
          if (offlineUntilTime > now) {
            // Normal countdown before expiration
            const remainingMs = offlineUntilTime - now;
            const totalMs = offlineUntilTime - createdTime; // –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ offlineUntil
            let ratio = remainingMs / totalMs;
            if (ratio < 0) ratio = 0;
            if (ratio > 1) ratio = 1;

            // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä: 100% = —Å–≤–µ–∂–µ–µ, 0% = –∏—Å—Ç–µ–∫–ª–æ
            progressFill.style.width = (ratio * 100) + "%";

            // –¢–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏
            const minutes = Math.floor(remainingMs / 60000);
            const seconds = Math.floor((remainingMs % 60000) / 1000);
            timeTextEl.textContent = `${minutes} min ${seconds} sec`;
          } else {
            // Time has expired‚Äîcheck for grace period
            if (!est.graceExpiresAt) {
              // Start grace period: 10 minutes
              const graceExpires = new Date(now + 10 * 60 * 1000).toISOString();
              db.ref("establishments/" + est.id).update({ graceExpiresAt: graceExpires });
              // Send notification
              const text = `üì¢ Admins only time expired for venue: ${est.name}\nYou can add extra time within the next 10 minutes or click "Set Expired" to mark it as expired.\nüîó ${est.url}\nReason: ${est.reason} / Added By: ${est.addedBy}`;
              sendWebhook(text);
              // Update local
              est.graceExpiresAt = graceExpires;

              progressFill.style.width = "0%";
              timeTextEl.textContent = "Grace: 10 min 0 sec";
            } else {
              // Grace period is active
              const graceExpiresTime = new Date(est.graceExpiresAt).getTime();
              const graceRemaining = graceExpiresTime - now;
              if (graceRemaining > 0) {
                const minutes = Math.floor(graceRemaining / 60000);
                const seconds = Math.floor((graceRemaining % 60000) / 1000);
                progressFill.style.width = "0%"; // –≤ grace-–ø–µ—Ä–∏–æ–¥–µ –ø—É—Å—Ç—å –±—É–¥–µ—Ç 0% (–≤—Ä–µ–º—è –≤—ã—à–ª–æ)
                timeTextEl.textContent = `Grace: ${minutes} min ${seconds} sec`;
              } else {
                // Grace period is over‚Äîmark as expired
                db.ref("establishments/" + est.id).update({ expired: true }, error => {
                  if (!error) {
                    const text = `üì¢ Admins only time fully expired for venue: ${est.name}\nüîó ${est.url}\nReason: ${est.reason}\nAdded By: ${est.addedBy}`;
                    sendWebhook(text);
                  }
                });
              }
            }
          }
        }
      });
    }

    // ===================== 7. ADD EXTRA TIME =====================
    function addExtraTime(id) {
      const additionalTime = prompt("Enter additional time (in minutes):");
      if (!additionalTime) return;

      const ref = db.ref("establishments/" + id);
      ref.once("value", snapshot => {
        const est = snapshot.val();
        if (!est) return;

        const additionalMs = parseInt(additionalTime, 10) * 60 * 1000;
        const newOfflineUntil = new Date(new Date(est.offlineUntil).getTime() + additionalMs);

        // –û–±–Ω–æ–≤–∏–º also createdAt, —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å—á–∏—Ç–∞–ª—Å—è –∑–∞–Ω–æ–≤–æ, –µ—Å–ª–∏ —Ö–æ—Ç–∏–º ¬´–Ω–æ–≤—ã–π —Ü–∏–∫–ª¬ª
        ref.update({
          offlineUntil: newOfflineUntil.toISOString(),
          expired: false,
          graceExpiresAt: null,
          createdAt: new Date().toISOString()
        }, error => {
          if (!error) {
            const text = `üîï Added extra time (${additionalTime} min) for venue ${est.name}\nNew offline until: ${newOfflineUntil.toLocaleString()}\nReason: ${est.reason} / Added By: ${est.addedBy}`;
            sendWebhook(text);

            // Force re-read
            db.ref("establishments").once("value", snap => {
              const data = snap.val();
              currentEstablishments = data ? Object.values(data) : [];
              renderDashboards(currentEstablishments);
            });
          }
        });
      });
    }

    // ===================== 8. SET EXPIRED NOW =====================
    function setExpiredNow(id) {
      const ref = db.ref("establishments/" + id);
      ref.update({ expired: true }, error => {
        if (!error) {
          ref.once("value", snap => {
            const est = snap.val();
            const text = `üîï Admins only status expired for venue: ${est.name}\nüîó Venue URL: ${est.url}\nReason: ${est.reason}\nAdded By: ${est.addedBy}`;
            sendWebhook(text);
          });
        }
      });
    }

    // ===================== 9. INITIALIZATION =====================
    window.addEventListener("load", () => {
      subscribeToDashboard();
      setInterval(updateTimers, 1000);
    });

    // ===================== 10. FORM HANDLING =====================
    document.getElementById("addEstablishmentForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const addedBy = document.getElementById("addedBy").value;
      const name = document.getElementById("name").value;
      const url = document.getElementById("url").value;
      const offlineTimeMinutes = parseInt(document.getElementById("offlineTime").value, 10);
      const reason = document.getElementById("reason").value;

      const now = new Date();
      const offlineUntil = new Date(now.getTime() + offlineTimeMinutes * 60 * 1000);

      const establishment = {
        addedBy: addedBy,
        name: name,
        url: url,
        offlineUntil: offlineUntil.toISOString(),
        addedOfflineTime: offlineTimeMinutes,
        reason: reason,
        expired: false,
        graceExpiresAt: null,
        createdAt: now.toISOString()    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, –∫–æ–≥–¥–∞ –∑–∞–≤–µ–¥–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ
      };

      addEstablishment(establishment);
      e.target.reset();
    });
  </script>
</body>
</html>
