<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Управление оффлайн-заведениями</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .form-section, .dashboard {
      margin-bottom: 30px;
    }
    .dashboard table {
      width: 100%;
      border-collapse: collapse;
    }
    .dashboard th, .dashboard td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    .dashboard th {
      background-color: #f2f2f2;
    }
    button {
      cursor: pointer;
    }
  </style>
  
  <!-- Подключаем Firebase (версия compat для упрощённого синтаксиса) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <script>
    // ======== ЗАМЕНИТЕ НИЖЕ СВОИМИ ДАННЫМИ ИЗ Firebase Console ========
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    // Инициализируем Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // URL вашего Slack вебхука
    const slackWebhookURL = "https://hooks.slack.com/triggers/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";
    
    // Функция отправки POST-запроса на вебхук
    function sendWebhook(text) {
      fetch(slackWebhookURL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ text: text })
      })
      .then(response => response.text())
      .then(data => console.log("Ответ вебхука:", data))
      .catch(err => console.error("Ошибка вебхука:", err));
    }
    
    // Добавление нового заведения в базу
    function addEstablishment(establishment) {
      // Push создаст новый уникальный ключ для записи
      const newRef = db.ref("establishments").push();
      establishment.id = newRef.key;
      newRef.set(establishment, error => {
        if (!error) {
          const text = `Добавлено заведение: ${establishment.name}.\nСсылка: ${establishment.url}.\nОффлайн до: ${new Date(establishment.offlineUntil).toLocaleString()}.`;
          sendWebhook(text);
        } else {
          console.error("Ошибка сохранения:", error);
        }
      });
    }
    
    // Слушаем изменения в базе для обновления дэшбоарда
    function subscribeToDashboard() {
      db.ref("establishments").on("value", snapshot => {
        const data = snapshot.val();
        const establishments = data ? Object.values(data) : [];
        renderDashboard(establishments);
      });
    }
    
    // Отрисовка дэшбоарда
    function renderDashboard(establishments) {
      const tbody = document.getElementById("dashboardTable").querySelector("tbody");
      tbody.innerHTML = "";
      
      establishments.forEach(est => {
        // Создаем строку таблицы для каждого заведения
        const tr = document.createElement("tr");
        
        // Имя заведения
        const tdName = document.createElement("td");
        tdName.textContent = est.name;
        tr.appendChild(tdName);
        
        // Ссылка
        const tdUrl = document.createElement("td");
        const link = document.createElement("a");
        link.href = est.url;
        link.target = "_blank";
        link.textContent = "Ссылка";
        tdUrl.appendChild(link);
        tr.appendChild(tdUrl);
        
        // Таймер оставшегося времени
        const tdTimer = document.createElement("td");
        tdTimer.id = "timer-" + est.id;
        tr.appendChild(tdTimer);
        
        // Действия: кнопка "Добавить время"
        const tdAction = document.createElement("td");
        const addTimeBtn = document.createElement("button");
        addTimeBtn.textContent = "Добавить время";
        addTimeBtn.addEventListener("click", function() {
          addExtraTime(est.id);
        });
        tdAction.appendChild(addTimeBtn);
        tr.appendChild(tdAction);
        
        tbody.appendChild(tr);
      });
    }
    
    // Обновление таймеров – каждую секунду
    function updateTimers() {
      db.ref("establishments").once("value", snapshot => {
        const data = snapshot.val();
        if (data) {
          Object.values(data).forEach(est => {
            const timerTd = document.getElementById("timer-" + est.id);
            if (timerTd) {
              const now = new Date();
              const offlineUntil = new Date(est.offlineUntil);
              const remainingMs = offlineUntil - now;
              if (remainingMs > 0) {
                const minutes = Math.floor(remainingMs / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);
                timerTd.textContent = `${minutes} мин ${seconds} сек`;
              } else {
                timerTd.textContent = "Время истекло";
                if (!est.expired) {
                  // Обновляем запись: устанавливаем expired в true
                  db.ref("establishments/" + est.id).update({ expired: true }, error => {
                    if (!error) {
                      const text = `Оффлайн время истекло для заведения: ${est.name}.\n(${est.url})`;
                      sendWebhook(text);
                    }
                  });
                }
              }
            }
          });
        }
      });
    }
    
    // Функция для добавления дополнительного времени вручную
    function addExtraTime(id) {
      const additionalTime = prompt("Введите дополнительное время в минутах:");
      if (!additionalTime) return;
      const additionalMs = parseInt(additionalTime, 10) * 60 * 1000;
      // Сначала получаем текущие данные заведения, затем обновляем offlineUntil
      const ref = db.ref("establishments/" + id);
      ref.once("value", snapshot => {
        const est = snapshot.val();
        if (est) {
          const newOfflineUntil = new Date(new Date(est.offlineUntil).getTime() + additionalMs);
          ref.update({ offlineUntil: newOfflineUntil, expired: false }, error => {
            if (!error) {
              const text = `Для заведения ${est.name} добавлено дополнительное время (${additionalTime} мин).\nНовый оффлайн до: ${newOfflineUntil.toLocaleString()}.`;
              sendWebhook(text);
            }
          });
        }
      });
    }
    
    // Запускаем обновление таймеров каждую секунду
    setInterval(updateTimers, 1000);
    
    // Подписываемся на обновления дэшбоарда при загрузке страницы
    window.addEventListener("load", subscribeToDashboard);
    
    // Обработчик формы добавления нового заведения
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("addEstablishmentForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const name = document.getElementById("name").value;
        const url = document.getElementById("url").value;
        const offlineTimeMinutes = parseInt(document.getElementById("offlineTime").value, 10);
        const now = new Date();
        const offlineUntil = new Date(now.getTime() + offlineTimeMinutes * 60 * 1000);
        
        const establishment = {
          name: name,
          url: url,
          offlineUntil: offlineUntil.toISOString(),
          addedOfflineTime: offlineTimeMinutes,
          expired: false
        };
        
        // Сохраняем заведение в Firebase
        addEstablishment(establishment);
        
        // Сброс формы
        e.target.reset();
      });
    });
  </script>
</head>
<body>
  <h1>Управление оффлайн-заведениями</h1>
  
  <!-- Форма для добавления заведения -->
  <div class="form-section">
    <h2>Добавить заведение</h2>
    <form id="addEstablishmentForm">
      <label>
        Имя заведения: <input type="text" id="name" required>
      </label><br><br>
      <label>
        Ссылка: <input type="url" id="url" required>
      </label><br><br>
      <label>
        Время оффлайн (в минутах): <input type="number" id="offlineTime" required>
      </label><br><br>
      <button type="submit">Добавить заведение</button>
    </form>
  </div>
  
  <!-- Дэшбоард заведений -->
  <div class="dashboard">
    <h2>Заведения в оффлайн-режиме</h2>
    <table id="dashboardTable">
      <thead>
        <tr>
          <th>Имя заведения</th>
          <th>Ссылка</th>
          <th>Оставшееся время</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <!-- Данные подставляются динамически из Firebase -->
      </tbody>
    </table>
  </div>
</body>
</html>
