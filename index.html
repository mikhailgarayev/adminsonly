<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Offline Venues Management</title>
  <!-- Include Firebase SDK (compat versions for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* Reset margins and paddings */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Background image from background.png located in the repository */
    body {
      background: url("background.png") no-repeat center center fixed;
      background-size: cover;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Site title styling */
    h1.site-title {
      color: #fff;
      font-size: 2rem;
      margin-top: 40px;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    /* Main card container */
    .card {
      background: #fff;
      border-radius: 10px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 40px;
    }

    h2 {
      margin-bottom: 10px;
      color: #333;
    }

    .form-section, .dashboard {
      margin-bottom: 30px;
    }

    /* Form styling */
    form label {
      display: block;
      margin: 10px 0 0;
      color: #333;
    }

    select, input[type="text"], input[type="url"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #00c2ff;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #00a9dc;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f7f7f7;
      color: #333;
    }

    a {
      color: #00c2ff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1 class="site-title">Offline Venues Management</h1>
  <div class="card">
    <!-- Form section to add a venue -->
    <div class="form-section">
      <h2>Add Venue</h2>
      <form id="addEstablishmentForm">
        <label>
          Your Name:
          <input type="text" id="addedBy" required>
        </label>
        <label>
          Venue Name:
          <input type="text" id="name" required>
        </label>
        <label>
          URL:
          <input type="url" id="url" required>
        </label>
        <label>
          Offline Time (in minutes):
          <input type="number" id="offlineTime" required>
        </label>
        <label>
          Reason for Offline:
          <select id="reason" required>
            <option value="" disabled selected>Select reason</option>
            <option value="Integration issues / Tech issues">Integration issues / Tech issues</option>
            <option value="Venue sets itself online">Venue sets itself online</option>
          </select>
        </label>
        <button type="submit">Add Venue</button>
      </form>
    </div>

    <!-- Dashboard section with Active Venues and History -->
    <div class="dashboard">
      <h2>Active Venues</h2>
      <table id="activeTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Time Left</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Active venues will be injected dynamically -->
        </tbody>
      </table>
      
      <h2>History (Expired Venues)</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Venue Name</th>
            <th>Added By</th>
            <th>Reason</th>
            <th>URL</th>
            <th>Offline Until</th>
          </tr>
        </thead>
        <tbody>
          <!-- Expired venues will be injected dynamically -->
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    // ===================== 1. FIREBASE INITIALIZATION =====================
    const firebaseConfig = {
      apiKey: "AIzaSyBaQYzQmld5VNA_wSI8nDtqENN0TgcNqeA",
      authDomain: "adminsonly.firebaseapp.com",
      databaseURL: "https://adminsonly-default-rtdb.firebaseio.com",
      projectId: "adminsonly",
      storageBucket: "adminsonly.firebasestorage.app",
      messagingSenderId: "194528429901",
      appId: "1:194528429901:web:805ca2f1dd0feca2de1904"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===================== 2. SLACK WEBHOOK =====================
    // Use your Slack Workflow Web Request URL
    const slackWebhookURL = "https://hooks.slack.com/triggers/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";
    // Function to send notifications using only the text field
    function sendWebhook(text) {
      const payload = {
        text: text
      };

      fetch(slackWebhookURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(() => console.log("Workflow webhook sent."))
      .catch(err => console.error("Webhook error:", err));
    }

    // ===================== 3. ADD VENUE FUNCTION =====================
    function addEstablishment(establishment) {
      const newRef = db.ref("establishments").push();
      establishment.id = newRef.key;
      newRef.set(establishment, error => {
        if (!error) {
          const text = `Added Venue: ${establishment.name}.
URL: ${establishment.url}.
Offline Until: ${new Date(establishment.offlineUntil).toLocaleString()}.
Reason: ${establishment.reason}.
Added By: ${establishment.addedBy}`;
          sendWebhook(text);
        } else {
          console.error("Save error:", error);
        }
      });
    }

    // Global variable to hold the current establishments data
    let currentEstablishments = [];

    // ===================== 4. SUBSCRIBE TO DATABASE UPDATES =====================
    function subscribeToDashboard() {
      db.ref("establishments").on("value", snapshot => {
        const data = snapshot.val();
        const allEstablishments = data ? Object.values(data) : [];
        currentEstablishments = allEstablishments;
        renderDashboards(allEstablishments);
      });
    }

    // ===================== 5. RENDER DASHBOARDS =====================
    function renderDashboards(establishments) {
      const activeTbody = document.getElementById("activeTable").querySelector("tbody");
      const historyTbody = document.getElementById("historyTable").querySelector("tbody");
      activeTbody.innerHTML = "";
      historyTbody.innerHTML = "";
      
      establishments.forEach(est => {
        if (est.expired) {
          // Render expired venue in History
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);

          const tdAddedBy = document.createElement("td");
          tdAddedBy.textContent = est.addedBy || "";
          tr.appendChild(tdAddedBy);

          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);

          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Visit";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);

          const tdOfflineUntil = document.createElement("td");
          tdOfflineUntil.textContent = new Date(est.offlineUntil).toLocaleString();
          tr.appendChild(tdOfflineUntil);

          historyTbody.appendChild(tr);
        } else {
          // Render active venue
          const tr = document.createElement("tr");
          
          const tdName = document.createElement("td");
          tdName.textContent = est.name;
          tr.appendChild(tdName);
          
          const tdAddedBy = document.createElement("td");
          tdAddedBy.textContent = est.addedBy || "";
          tr.appendChild(tdAddedBy);

          const tdReason = document.createElement("td");
          tdReason.textContent = est.reason || "";
          tr.appendChild(tdReason);

          const tdUrl = document.createElement("td");
          const link = document.createElement("a");
          link.href = est.url;
          link.target = "_blank";
          link.textContent = "Visit";
          tdUrl.appendChild(link);
          tr.appendChild(tdUrl);
          
          const tdTimer = document.createElement("td");
          tdTimer.id = "timer-" + est.id;
          tr.appendChild(tdTimer);
          
          const tdAction = document.createElement("td");
          const addTimeBtn = document.createElement("button");
          addTimeBtn.textContent = "Add Extra Time";
          addTimeBtn.addEventListener("click", function() {
            addExtraTime(est.id);
          });
          tdAction.appendChild(addTimeBtn);
          tr.appendChild(tdAction);
          
          activeTbody.appendChild(tr);
        }
      });
    }

    // ===================== 6. UPDATE TIMERS =====================
    // Modified to use the global currentEstablishments array rather than a separate DB query.
    function updateTimers() {
      currentEstablishments.forEach(est => {
        if (!est.expired) {
          const timerTd = document.getElementById("timer-" + est.id);
          if (timerTd) {
            const now = new Date();
            const offlineUntil = new Date(est.offlineUntil);
            const remainingMs = offlineUntil - now;
            if (remainingMs > 0) {
              const minutes = Math.floor(remainingMs / 60000);
              const seconds = Math.floor((remainingMs % 60000) / 1000);
              timerTd.textContent = `${minutes} min ${seconds} sec`;
            } else {
              timerTd.textContent = "Time Expired";
              // Only mark as expired if not updated by extra time already.
              db.ref("establishments/" + est.id).update({ expired: true }, error => {
                if (!error) {
                  const text = `Offline time expired for venue: ${est.name}.
(${est.url})
Reason: ${est.reason}.
Added By: ${est.addedBy}`;
                  sendWebhook(text);
                }
              });
            }
          }
        }
      });
    }

    // ===================== 7. ADD EXTRA TIME =====================
    function addExtraTime(id) {
      const additionalTime = prompt("Enter additional time (in minutes):");
      if (!additionalTime) return;
      const additionalMs = parseInt(additionalTime, 10) * 60 * 1000;
      const ref = db.ref("establishments/" + id);
      ref.once("value", snapshot => {
        const est = snapshot.val();
        if (est) {
          // Calculate new offlineUntil based on the current offlineUntil value
          const newOfflineUntil = new Date(new Date(est.offlineUntil).getTime() + additionalMs);
          // Update offlineUntil and ensure expired is set to false
          ref.update({ offlineUntil: newOfflineUntil, expired: false }, error => {
            if (!error) {
              const text = `Added extra time (${additionalTime} min) for venue ${est.name}.
New offline until: ${newOfflineUntil.toLocaleString()}.
Reason: ${est.reason}.
Added By: ${est.addedBy}`;
              sendWebhook(text);
            }
          });
        }
      });
    }

    // ===================== 8. INITIALIZATION =====================
    window.addEventListener("load", () => {
      subscribeToDashboard();
      setInterval(updateTimers, 1000);
    });

    // ===================== 9. FORM HANDLING =====================
    document.getElementById("addEstablishmentForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const addedBy = document.getElementById("addedBy").value;
      const name = document.getElementById("name").value;
      const url = document.getElementById("url").value;
      const offlineTimeMinutes = parseInt(document.getElementById("offlineTime").value, 10);
      const reason = document.getElementById("reason").value;
      const now = new Date();
      const offlineUntil = new Date(now.getTime() + offlineTimeMinutes * 60 * 1000);
      
      const establishment = {
        addedBy: addedBy,
        name: name,
        url: url,
        offlineUntil: offlineUntil.toISOString(),
        addedOfflineTime: offlineTimeMinutes,
        reason: reason,
        expired: false
      };
      
      addEstablishment(establishment);
      e.target.reset();
    });
  </script>
</body>
</html>
